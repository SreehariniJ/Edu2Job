<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Profile</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  .tag {
    display: inline-block;
    background: linear-gradient(90deg, #4f46e5, #6366f1);
    color: white;
    padding: 4px 10px;
    border-radius: 20px;
    margin: 2px;
    font-size: 0.875rem;
    cursor: pointer;
    transition: transform 0.2s;
  }
  .tag:hover { transform: scale(1.1); }
  .floating-label {
    position: absolute;
    left: 0.75rem;
    top: 0.75rem;
    transition: all 0.2s ease-out;
    pointer-events: none;
    color: #6b7280;
  }
  .input-container { position: relative; }
  input:not(:placeholder-shown) + label, select:not([value=""]) + label {
    transform: translateY(-1.5rem);
    font-size: 0.75rem;
    color: #4f46e5;
  }
  input:focus + label, select:focus + label {
    transform: translateY(-1.5rem);
    font-size: 0.75rem;
    color: #4f46e5;
  }
</style>
</head>
<body class="bg-gradient-to-b from-indigo-100 to-blue-50 min-h-screen flex items-center justify-center">

<div class="w-full max-w-4xl bg-white rounded-2xl shadow-2xl p-8 md:p-12 relative">
  <div class="text-center mb-8">
    <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-3">My Profile</h1>
    <button type="button" onclick="window.location.href='/dashboard'" class="px-6 py-2 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-full hover:from-indigo-600 hover:to-purple-500 transition-all">Back to Dashboard</button>
  </div>

  <!-- Profile Photo - Fixed Version -->
  <div class="flex justify-center mb-8">
    <div class="relative">
      <img id="profilePreview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150' viewBox='0 0 24 24'%3E%3Cpath fill='%23999' d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E" 
           alt="Profile Photo" class="w-36 h-36 object-cover rounded-full border-4 border-indigo-300 shadow-lg">
      
      <!-- Upload Button -->
      <label for="profile_photo" class="absolute bottom-0 right-0 bg-indigo-500 text-white p-2 rounded-full cursor-pointer hover:bg-indigo-600 transition-colors">
        <i class="fas fa-camera"></i>
        <input type="file" id="profile_photo" name="profile_photo" class="hidden" accept="image/*">
      </label>
      
      <!-- Remove Button -->
      <button type="button" id="removePhoto" class="absolute bottom-0 left-0 bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors">
        <i class="fas fa-trash"></i>
      </button>
    </div>
  </div>

  <form id="profileForm" class="space-y-6">

    <!-- Full Name & Email (readonly) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="input-container">
        <input type="text" id="fullname" name="fullname" placeholder=" " readonly class="w-full border-b-2 border-gray-300 focus:border-indigo-500 outline-none py-2">
        <label class="floating-label">Full Name</label>
      </div>
      <div class="input-container">
        <input type="email" id="email" name="email" placeholder=" " readonly class="w-full border-b-2 border-gray-300 focus:border-indigo-500 outline-none py-2">
        <label class="floating-label">Email</label>
      </div>
    </div>

    <!-- Degree & Major -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="input-container">
        <input type="text" id="degree" name="degree" placeholder=" " class="w-full border-b-2 border-gray-300 focus:border-indigo-500 outline-none py-2">
        <label class="floating-label">Degree</label>
      </div>
      <div class="input-container">
        <input type="text" id="major" name="major" placeholder=" " class="w-full border-b-2 border-gray-300 focus:border-indigo-500 outline-none py-2">
        <label class="floating-label">Major</label>
      </div>
    </div>

    <!-- CGPA & Graduation Year -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="input-container">
        <input type="number" step="0.01" id="cgpa" name="cgpa" placeholder=" " class="w-full border-b-2 border-gray-300 focus:border-indigo-500 outline-none py-2">
        <label class="floating-label">CGPA</label>
      </div>
      <div class="input-container">
        <input type="number" id="graduation_year" name="graduation_year" placeholder=" " class="w-full border-b-2 border-gray-300 focus:border-indigo-500 outline-none py-2">
        <label class="floating-label">Graduation Year</label>
      </div>
    </div>

    <!-- Phone & Country Code -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="input-container">
        <input type="text" id="country_code" name="country_code" placeholder=" " class="w-full border-b-2 border-gray-300 focus:border-indigo-500 outline-none py-2">
        <label class="floating-label">Country Code</label>
      </div>
      <div class="input-container">
        <input type="text" id="phone" name="phone" placeholder=" " class="w-full border-b-2 border-gray-300 focus:border-indigo-500 outline-none py-2">
        <label class="floating-label">Phone</label>
      </div>
    </div>

    <!-- Skills -->
    <div>
      <label class="block font-medium mb-2 text-gray-700">Skills</label>
      <div id="skillsContainer" class="border p-3 rounded min-h-[60px] flex flex-wrap bg-indigo-50"></div>
      <input type="text" id="skillInput" placeholder="Type a skill and press Enter" class="w-full border p-2 rounded mt-2 focus:ring-2 focus:ring-indigo-400">
    </div>

    <!-- College -->
    <div>
      <label class="block font-medium mb-2 text-gray-700">College</label>
      <select id="college" name="college" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-400">
      </select>
      <input type="text" id="otherCollege" placeholder="Enter your college" class="w-full border p-2 rounded mt-2 hidden focus:ring-2 focus:ring-indigo-400">
    </div>

    <button type="submit" class="w-full py-3 mt-4 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-full font-bold hover:from-indigo-600 hover:to-purple-500 transition-all">Save Profile</button>
  </form>
</div>

<script>
// Mock data for demonstration
const mockUserData = {
  fullname: "John Doe",
  email: "john.doe@example.com",
  degree: "B.Tech",
  major: "Computer Science",
  cgpa: 8.5,
  graduation_year: 2024,
  phone: "9876543210",
  country_code: "+91",
  skills: ["JavaScript", "Python", "React"],
  college: "Indian Institute of Technology Bombay",
  profile_photo_url: ""
};

const collegeList = [
  "Indian Institute of Technology Bombay",
  "Indian Institute of Technology Delhi",
  "Indian Institute of Technology Madras",
  "Indian Institute of Technology Kanpur",
  "Indian Institute of Technology Kharagpur",
  "Indian Institute of Technology Roorkee",
  "Indian Institute of Technology Guwahati",
  "Indian Institute of Technology BHU",
  "National Institute of Technology Trichy",
  "National Institute of Technology Surathkal",
  "Others"
];

// Initialize college dropdown
const collegeSelect = document.getElementById("college");
const otherCollegeInput = document.getElementById("otherCollege");

collegeList.forEach(c => {
  const opt = document.createElement("option");
  opt.value = c;
  opt.textContent = c;
  collegeSelect.appendChild(opt);
});

collegeSelect.addEventListener("change", () => {
  otherCollegeInput.style.display = collegeSelect.value === "Others" ? "block" : "none";
  if (collegeSelect.value !== "Others") {
    otherCollegeInput.value = "";
  }
});

// Skills handling
const skillsContainer = document.getElementById("skillsContainer");
const skillInput = document.getElementById("skillInput");
let skills = [];

function renderSkills() {
  skillsContainer.innerHTML = "";
  skills.forEach((s, idx) => {
    const span = document.createElement("span");
    span.className = "tag";
    span.textContent = s;
    span.onclick = () => { 
      skills.splice(idx, 1); 
      renderSkills(); 
    };
    skillsContainer.appendChild(span);
  });
}

skillInput.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    const val = skillInput.value.trim();
    if (val && !skills.includes(val)) {
      skills.push(val);
      renderSkills();
      skillInput.value = "";
    }
  }
});

// Profile photo handling
const profilePreview = document.getElementById("profilePreview");
const profilePhotoInput = document.getElementById("profile_photo");
const removePhotoBtn = document.getElementById("removePhoto");
const defaultAvatar = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150' viewBox='0 0 24 24'%3E%3Cpath fill='%23999' d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E";

profilePhotoInput.addEventListener("change", function() {
  const file = this.files[0];
  if (file) {
    // Validate file type
    if (!file.type.startsWith('image/')) {
      alert('Please select an image file (JPEG, PNG, etc.)');
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
      profilePreview.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }
});

removePhotoBtn.addEventListener("click", function() {
  profilePreview.src = defaultAvatar;
  profilePhotoInput.value = "";
});

// Load profile data
async function loadProfile() {
  try {
    const token = localStorage.getItem("token");
    let userData = mockUserData;

    // Try to fetch from API if token exists
    if (token) {
      try {
        const response = await fetch("/api/profile", {
          headers: { "Authorization": "Bearer " + token }
        });
        
        if (response.ok) {
          userData = await response.json();
        }
      } catch (error) {
        console.log("Using mock data - API not available");
      }
    }

    // Populate form with data
    document.getElementById("fullname").value = userData.fullname || "";
    document.getElementById("email").value = userData.email || "";
    document.getElementById("degree").value = userData.degree || "";
    document.getElementById("major").value = userData.major || "";
    document.getElementById("cgpa").value = userData.cgpa || "";
    document.getElementById("graduation_year").value = userData.graduation_year || "";
    document.getElementById("phone").value = userData.phone || "";
    document.getElementById("country_code").value = userData.country_code || "";

    // Handle skills
    skills = Array.isArray(userData.skills) ? userData.skills : [];
    renderSkills();

    // Handle college
    if (userData.college) {
      if (collegeList.includes(userData.college)) {
        collegeSelect.value = userData.college;
      } else {
        collegeSelect.value = "Others";
        otherCollegeInput.style.display = "block";
        otherCollegeInput.value = userData.college;
      }
    }

    // Handle profile photo
    if (userData.profile_photo_url) {
      profilePreview.src = userData.profile_photo_url;
    }

  } catch (error) {
    console.error("Error loading profile:", error);
  }
}

// Save profile
document.getElementById("profileForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  
  try {
    const token = localStorage.getItem("token");
    const formData = new FormData();
    
    // Add form data
    formData.append("degree", document.getElementById("degree").value);
    formData.append("major", document.getElementById("major").value);
    formData.append("cgpa", document.getElementById("cgpa").value);
    formData.append("graduation_year", document.getElementById("graduation_year").value);
    formData.append("phone", document.getElementById("phone").value);
    formData.append("country_code", document.getElementById("country_code").value);

    const selectedCollege = collegeSelect.value === "Others" ? 
      otherCollegeInput.value : collegeSelect.value;
    formData.append("college", selectedCollege);

    formData.append("skills", skills.join(","));
    
    // Add profile photo if selected
    if (profilePhotoInput.files[0]) {
      formData.append("profile_photo", profilePhotoInput.files[0]);
    }

    // Try to save to API if token exists
    if (token) {
      const response = await fetch("/api/profile", {
        method: "POST",
        headers: { "Authorization": "Bearer " + token },
        body: formData
      });

      if (response.ok) {
        const result = await response.json();
        alert(result.message || "Profile updated successfully!");
      } else {
        const error = await response.json();
        alert(error.error || "Failed to update profile");
      }
    } else {
      // Demo mode - just show success message
      alert("Profile saved successfully! (Demo Mode)");
    }
    
  } catch (error) {
    console.error("Error saving profile:", error);
    alert("Error saving profile. Please try again.");
  }
});

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
  loadProfile();
});
</script>

</body>
</html>